//1. Report the min and max of AQI value for each State during each quarter of years.
SELECT
	NONEMPTYCROSSJOIN([Dim Geography].[State Name].[State Name],{[Measures].[MinAQI],[Measures].[MaxAQI]}) on rows,
	NONEMPTYCROSSJOIN([Dim Time].[Hierarchy].[Year],[Dim Time].[Quarter].[Quarter]) on columns
FROM 
	[Cube_DDSAirQuality];


//2. Report the mean and the standard deviation of AQI value for each State during each quarter of years.
WITH 
-- Tính độ lệch chuẩn (Standard Deviation) cho từng quý trong năm
MEMBER [Measures].[StdDevAQI] AS 
    StDevP(
        [Dim Time].[Hierarchy].CurrentMember.Children,
        [Measures].[MeanAQI]
    )

SELECT 
    {[Measures].[MeanAQI], [Measures].[StdDevAQI]} ON COLUMNS,
    ([Dim Geography].[State Name].[State Name] * 
    [Dim Time].[Hierarchy].[Year] * 
    [Dim Time].[Quarter].[Quarter]) ON ROWS
FROM 
	[Cube_DDSAirQuality];


//3. Report the number of days, and the mean AQI value where the air quality is rated as "very unhealthy" or worse for each State and County.
WITH 
-- Số ngày có chất lượng không khí "bad" (category ID 5 hoặc 6)
MEMBER [Measures].[DaysWithBadAQI] AS
    COUNT(
        FILTER(
            [Dim Time].[Date].[Date].MEMBERS,
            ([Measures].[AQI], [Dim AQ Category].[Category ID].&[5]) > 0
            OR
            ([Measures].[AQI], [Dim AQ Category].[Category ID].&[6]) > 0
        )
    )
SELECT 
    {[Measures].[DaysWithBadAQI], [Measures].[MeanAQI]} ON COLUMNS,
    FILTER(
        NONEMPTYCROSSJOIN(
            [Dim Geography].[State Name].[State Name].MEMBERS,
            [Dim Geography].[County Name].[County Name].MEMBERS
        ),
        [Measures].[DaysWithBadAQI] > 0 
    ) 
	ON ROWS
FROM 
    [Cube_DDSAirQuality]
WHERE 
    {[Dim AQ Category].[Category ID].&[5], [Dim AQ Category].[Category ID].&[6]};
//4.For the four following states: Hawaii, Alaska, Illinois and Delaware, count the
//number of days in each air quality Category (Good, Moderate,etc.) by County.
WITH 
MEMBER [Measures].[DaysInCategory] AS
    COUNT(
        FILTER(
            [Dim Time].[Date].[Date].MEMBERS,
            NOT IsEmpty([Measures].[AQI])
        )
    )

SELECT
    NONEMPTY(
        [Dim AQ Category].[Category ID].[Category ID].MEMBERS
        * {[Measures].[DaysInCategory]}
    ) ON COLUMNS,
	NONEMPTY(
		{[Dim Geography].[State Name].&[Hawaii],
		 [Dim Geography].[State Name].&[Alaska],
		 [Dim Geography].[State Name].&[Illinois],
		 [Dim Geography].[State Name].&[Delaware]}
		* [Dim Geography].[County Name].[County Name].MEMBERS
		) ON ROWS
FROM 
	[Cube_DDSAirQuality];
//5. For the four following states: Hawaii, Alaska, Illinois and Delaware, 
//compute the mean AQI value by quarters.
SELECT
    NONEMPTY(
        CROSSJOIN([Measures].[MeanAQI], 
        CROSSJOIN([Dim Time].[Hierarchy].[Year],[Dim Time].[Quarter].[Quarter]))
    ) ON ROWS,
    NONEMPTY(
    {[Dim Geography].[State Name].&[Hawaii],
     [Dim Geography].[State Name].&[Alaska],
     [Dim Geography].[State Name].&[Illinois],
     [Dim Geography].[State Name].&[Delaware]}
    ) ON COLUMNS
FROM
    [Cube_DDSAirQuality];

//6. Design a report to demonstrate the AQI fluctuation trends over the year
//for the four following states: Hawaii, Alaska, Illinois and California.
SELECT
    NONEMPTY(
        CROSSJOIN([Measures].[AQI],
               [Dim Time].[Hierarchy].[Year])
        )
    ON COLUMNS,
    NONEMPTY(
    {[Dim Geography].[State Name].&[Hawaii],
     [Dim Geography].[State Name].&[Alaska],
     [Dim Geography].[State Name].&[Illinois],
     [Dim Geography].[State Name].&[California]}
    ) ON ROWS
FROM
    [Cube_DDSAirQuality];
//9. Report the mean, the standard deviation, min and max of AQI value group by
//State and County during each quarter of the year
WITH 
-- Tính độ lệch chuẩn (Standard Deviation) cho từng quý trong năm
MEMBER [Measures].[StdDevAQI] AS 
    StDevP(
        [Dim Time].[Hierarchy].CurrentMember.Children,
        [Measures].[MeanAQI]
    )
SELECT 
    {[Measures].[MaxAQI], [Measures].[MinAQI], 
	[Measures].[MeanAQI], [Measures].[StdDevAQI]} ON COLUMNS,
    ([Dim Geography].[State Name].[State Name] * 
    [Dim Time].[Hierarchy].[Year] * 
    [Dim Time].[Quarter].[Quarter]) ON ROWS
FROM 
	[Cube_DDSAirQuality];
//10 Report the mean AQI value by State, Category, DayLightSaving over years.
WITH
-- Tạo cột DayLightSaving
MEMBER [Measures].[DayLightSaving] AS
    IIF(
        [Dim Time].[Date].CURRENTMEMBER.MemberValue >= CDate("2023-03-12") AND 
        [Dim Time].[Date].CURRENTMEMBER.MemberValue <= CDate("2023-11-05"),
        "True",   -- Khi ngày nằm trong khoảng thời gian Daylight Saving
        "False"   -- Khi ngày không nằm trong khoảng thời gian Daylight Saving
    )
-- Lọc dữ liệu và xuất ra AQI trung bình theo State, Category, và DayLightSaving
SELECT 
    {[Measures].[DayLightSaving],[Measures].[MeanAQI]} ON COLUMNS,  -- Hiển thị AQI trung bình
    NONEMPTY(
            crossjoin([Dim Time].[Year].[Year] * [Dim Time].[Date].[Date],
			CROSSJOIN(
                [Dim Geography].[State Name].[State Name],  -- State
                [Dim AQ Category].[Category ID].[Category ID] -- Category
            )
        ))
    ON ROWS
FROM 
    [Cube_DDSAirQuality];
//11  Count the number of days by State, Category in each month.
WITH
-- Đếm số ngày dựa trên các ngày không rỗng
MEMBER [Measures].[Number of days] AS
    COUNT(
        NONEMPTY(
            [Dim Time].[Date].[Date],
             [Measures].[AQI]
        )
    )
-- Lấy dữ liệu theo Month, State, và Category
SELECT 
    crossjoin([Dim AQ Category].[Category ID].[Category ID],{[Measures].[Number of days]}) ON COLUMNS, -- Hiển thị tổng số ngày
    NONEMPTYCROSSJOIN([Dim Time].[Month].[Month], [Dim Geography].[State Name].[State Name])
    ON ROWS
FROM 
    [Cube_DDSAirQuality]
